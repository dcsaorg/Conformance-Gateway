@if (isLoading && !sandbox) {
  <app-text-waiting text="Retrieving sandbox metadata..."></app-text-waiting>
}

@if (sandbox) {
  <div>
    <div class="pageTitle">
        <span>Sandbox: {{sandbox.name}}</span>

        <span style="vertical-align: middle;">
            <button
            mat-icon-button
            color="primary"
            title="Settings"
            (click)="onClickSettings()"
            ><mat-icon>settings</mat-icon></button>
        </span>
        <span style="vertical-align: middle;">
            <button
                    testId="deleteSandboxButton"
                    mat-icon-button
                    color="primary"
                    title="Delete Sandbox"
                    (click)="onClickDeleteSandbox()"
            ><mat-icon>delete</mat-icon></button>
        </span>
    </div>
    <div class="paragraph">
        <app-sandbox-type [sandbox]="sandbox"></app-sandbox-type>
    </div>
  </div>
}

@if (isLoading && sandbox && !sandbox.canNotifyParty) {
  <app-text-waiting text="Retrieving scenarios..."></app-text-waiting>
}

@if (!isLoading && standardModules.length == 0) {
  <div class="pageSubtitle">No scenarios</div>
}

@if (startingOrStoppingScenario) {
  <app-text-waiting text="Updating scenario state..."></app-text-waiting>
}

@if (!isInternalSandbox()) {
  <div>
    <br />
    <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start">
        <mat-tab label="‚ñ∂Ô∏è Scenarios">
            @if (!startingOrStoppingScenario) {
              <div>
                @for (standardModule of standardModules; track standardModule.moduleName) {
                  <div>
                    <div class="pageSubtitle">{{standardModule.moduleName}}</div>

                    @for (scenario of standardModule.scenarios; track scenario.id) {
                      <mat-card [ngClass]="'entityCard'">
                        <div class="cardContent withPointerCursor" (click)="onScenarioClick(scenario)">
                            <button
                            class="scenarioActionButton"
                            mat-icon-button
                            color="primary"
                            [disabled]="cannotPerformAction(scenario)"
                            [title]="getActionTitle(scenario)"
                            (click)="onScenarioAction($event, scenario)"
                            ><mat-icon>{{getActionIconName(scenario)}}</mat-icon></button>

                            <span
                            id="conformanceStatus"
                            class="conformanceStatus"
                            [title]="getConformanceStatusTitle(scenario.conformanceStatus)"
                            >{{getConformanceStatusEmoji(scenario.conformanceStatus)}}</span>

                            <span class="wrappingText">{{scenario.name}}</span>
                        </div>
                      </mat-card>
                    }
                    <br/>
                  </div>
                }
              </div>
            }
        </mat-tab>
        <mat-tab label="üìú Reports">
            @if (!displayedReportDigest) {
              <div>
                <div class="paragraph">Create a report from the current sandbox state:</div>
                <br/>
                <mat-form-field class="fullWidth">
                    <mat-label>Optional report title</mat-label>
                    <input
                      matInput
                      type="text"
                      autocomplete="off"
                      name="newReportTitleTextField"
                      [(ngModel)]="newReportTitle"
                    />
                </mat-form-field>
                <div>
                    <button
                    mat-raised-button
                    color="primary"
                    (click)="onClickCreateReport()"
                    >Create report</button>
                </div>

                @for (reportDigest of reportDigests; track reportDigest.dateTime) {
                  <mat-card [ngClass]="'entityCard'">
                    <div class="cardContent withPointerCursor" (click)="onReportClick(reportDigest)">
                      <span style="margin: 8px" class="wrappingText">üìú {{reportDigest.dateTime}} {{reportDigest.title}}</span>
                    </div>
                  </mat-card>
                }
              </div>
            }

            @if (displayedReportDigest) {
              <div>
                <div class="paragraph withPointerCursor">
                  <a (click)="onClickBackToAllReports()">‚¨ÖÔ∏è Back to all reports</a>
                </div>

                @if (displayedReportContent) {
                  <app-report
                  [unfoldedLevels]="2"
                  [report]="displayedReportContent"
                  ></app-report>
                }
              </div>
            }

            <br />
        </mat-tab>
    </mat-tab-group>
  </div>
}

@if (isInternalSandbox()) {
  <div>
    <div class="paragraph">
        <button
        id="notifyPartyButton"
        mat-raised-button
        color="primary"
        (click)="onClickNotifyParty()"
        >Notify party</button>
        &nbsp;
        <button
          testId="resetPartyButton"
        mat-raised-button
        (click)="onClickResetParty()"
        >Reset party</button>
    </div>

    <div class="pageSubtitle">Activity</div>
    <div>(latest message at the top)</div>
    <div class="paragraph">
        <button
        mat-raised-button
        testId="refreshButton"
        color="primary"
        (click)="onClickRefresh()"
        >Refresh</button>
    </div>
    @if (sandbox && sandbox.operatorLog) {
      @for (logEntry of sandbox.operatorLog; track logEntry) {
        <div class="paragraph" testId="operatorLog">{{logEntry}}</div>
      }
    }
  </div>
}
